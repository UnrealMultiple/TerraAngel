using System;
using Microsoft.Xna.Framework.Input;
using TerraAngel.Net;

namespace TerraAngel.Tools.Exploit;

public class PortalTeleport : Tool
{
    public override string Name => GetString("Portal Teleport");
    public override ToolTabs Tab => ToolTabs.MiscTools;

    public bool[] IsExploiting = new bool[Main.maxPlayers];
    public float SendTimer;

    public override void DrawUI(ImGuiIOPtr io)
    {
        if (ImGui.CollapsingHeader(GetString("Portal Teleport")))
        {
            ImGui.Text(GetString("Press P to teleport"));
            if (ImGui.BeginTable("#PortalTeleportPlayerTable", 3,
                    ImGuiTableFlags.Borders |
                    ImGuiTableFlags.Resizable |
                    ImGuiTableFlags.RowBg |
                    ImGuiTableFlags.SizingFixedFit))
            {
                ImGui.TableSetupColumn(GetString("Player Name"), ImGuiTableColumnFlags.WidthStretch);
                ImGui.TableSetupColumn(GetString("Player ID"), ImGuiTableColumnFlags.WidthFixed, 80.0f);
                ImGui.TableSetupColumn(GetString("Action"), ImGuiTableColumnFlags.WidthFixed, 90.0f);
                ImGui.TableHeadersRow();

                for (int i = 0; i < Main.maxPlayers; i++)
                {
                    if (!Main.player[i].active)
                        continue;
                
                    ImGui.PushID(i);
                    ImGui.TableNextRow();
                
                    ImGui.TableSetColumnIndex(0);
                    ImGui.Text(Main.player[i].name);
                
                    ImGui.TableSetColumnIndex(1);
                    ImGui.Text(i.ToString());
                
                    ImGui.TableSetColumnIndex(2);
                    if (i != Main.myPlayer)
                    {
                        if (ImGui.Button(IsExploiting[i] ? GetString("Unselect!") : GetString("Select!")))
                            IsExploiting[i] = !IsExploiting[i];
                    }
                    else
                    {
                        ImGui.BeginDisabled();
                        ImGui.Button(GetString("Seriously?"));
                        ImGui.EndDisabled();
                    }
                
                    ImGui.PopID();
                }
                
                ImGui.EndTable();
            }
        }
    }

    public override void Update()
    {
        SendTimer -= Time.DrawDeltaTime;
        if (SendTimer > 0.0f)
            return;
        SendTimer = 0.05f;

        var hasExploited = false;
        for (int i = 0; i < Main.maxPlayers; i++)
        {
            if (!IsExploiting[i])
                continue;
            if (!Main.player[i].active)
            {
                IsExploiting[i] = false;
                continue;
            }
            
            if (!InputSystem.IsKeyDown(Keys.P))
                continue;
            hasExploited = true;

            var target = Main.mapFullscreen
                ? Util.ScreenToWorldFullscreenMap(InputSystem.MousePosition)
                : Util.ScreenToWorldWorld(InputSystem.MousePosition);
            
            // teleport to the player's position to bypass TShock range check
            SpecialNetMessage.SendData(MessageID.PlayerControls, null!, Main.myPlayer, Main.player[i].position.X, Main.player[i].position.Y, (float)Main.LocalPlayer.selectedItem);
            // create portal 1
            // with velocity prediction
            var x = Main.player[i].position.X + (float)Main.player[i].width / 2 + Main.player[i].velocity.X;
            var y = Main.player[i].position.Y + (float)Main.player[i].height / 2 + Main.player[i].velocity.Y;
            var a = Projectile.NewProjectile(null!, x, y, 0f, 0f, ProjectileID.PortalGunGate, 0, 0f, Main.myPlayer, (float)Math.PI, 0);
            // teleport to the target position to bypass TShock range check
            SpecialNetMessage.SendData(MessageID.PlayerControls, null!, Main.myPlayer, target.X, target.Y, (float)Main.LocalPlayer.selectedItem);
            // create portal 2
            var b = Projectile.NewProjectile(null!, target.X, target.Y, 0f, 0f, ProjectileID.PortalGunGate, 0, 0f, Main.myPlayer, (float)Math.PI, 1);
            // clear the portals immediately so we won't get hurt
            Main.projectile[a].active = false;
            Main.projectile[b].active = false;
        }
        
        if (hasExploited)
        {
            // sync with server with our real position
            NetMessage.SendData(MessageID.PlayerControls, number: Main.myPlayer);
        }
    }
}